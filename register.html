<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Register — Research</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>window.tailwind = {config:{theme:{extend:{fontFamily:{sans:['Inter','ui-sans-serif','system-ui']}}}}}</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="theme.css">
    <!-- Firebase SDK (optional) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js" defer></script>
  </head>
  <body class="bg-slate-50 font-sans text-slate-800">
    <main class="min-h-screen flex items-center justify-center px-4">
      <div class="w-full max-w-md p-6 card">
        <h2 class="text-xl font-semibold">Create an account</h2>
        <p class="text-sm muted mt-1">Register as a student or teacher (demo uses localStorage)</p>

        <form id="registerForm" class="mt-4 space-y-3">
          <div>
            <label class="text-sm">Full name</label>
            <input id="name" class="mt-1 block w-full rounded border-gray-200 p-2" required />
          </div>
          <div>
            <label class="text-sm">Email</label>
            <input id="email" type="email" class="mt-1 block w-full rounded border-gray-200 p-2" required />
          </div>
          <div>
            <label class="text-sm">Password</label>
            <input id="password" type="password" minlength="6" class="mt-1 block w-full rounded border-gray-200 p-2" required />
          </div>
          <div>
            <label class="text-sm">Confirm password</label>
            <input id="confirm" type="password" class="mt-1 block w-full rounded border-gray-200 p-2" required />
          </div>
          <div>
            <label class="text-sm">Role</label>
            <select id="role" class="mt-1 block w-full rounded border-gray-200 p-2">
              <option value="student">Student</option>
              <option value="teacher">Teacher</option>
            </select>
            <div class="mt-2 text-sm">
              <label class="inline-flex items-start gap-2"><input id="agree" type="checkbox" class="mt-1" /> <span>I agree to the <a href="terms.html" class="text-indigo-600 hover:underline">Terms & Data Use</a>.</span></label>
            </div>
          </div>

          <div class="flex items-center justify-between mt-4">
            <button type="submit" class="btn-primary">Register</button>
            <a href="login.html" class="text-sm yellow-link hover:underline">Already have an account?</a>
          </div>
        </form>

        <div id="msg" class="mt-3 text-sm text-red-600"></div>
      </div>
    </main>

    <script>
      function showMsg(text, ok){ const el = document.getElementById('msg'); el.textContent = text; el.className = ok? 'mt-3 text-sm text-green-600' : 'mt-3 text-sm text-red-600'; }
      document.getElementById('registerForm').addEventListener('submit', async function(e){
        e.preventDefault();
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim().toLowerCase();
        const password = document.getElementById('password').value;
        const confirm = document.getElementById('confirm').value;
        const role = document.getElementById('role').value;
        const agree = document.getElementById('agree').checked;
        if(password !== confirm){ showMsg('Passwords do not match'); return; }
        if(!agree){ showMsg('You must agree to the Terms & Data Use to register.'); return; }
        // If Firebase configured, create an Auth user and store profile in Firestore
        if(window.FIREBASE_CONFIG && window.firebase){
          try{
            if(!firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
            const cred = await firebase.auth().createUserWithEmailAndPassword(email, password);
            const u = cred.user;
            await firebase.firestore().collection('users').doc(u.uid).set({ name, email, role, createdAt: Date.now() });
            showMsg('Account created — redirecting to login...', true);
            setTimeout(()=> location.href = 'login.html?registered=1', 900);
          }catch(err){ showMsg(err.message || 'Firebase register failed'); }
          return;
        }

        // fallback: localStorage demo
        const users = JSON.parse(localStorage.getItem('users::demo') || '[]');
        if(users.find(u=> u.email === email)){ showMsg('An account with that email already exists'); return; }
        const user = { id: Date.now().toString(), name, email, password, role };
        users.push(user);
        localStorage.setItem('users::demo', JSON.stringify(users));
        showMsg('Account created — redirecting to login...', true);
        setTimeout(()=> location.href = 'login.html?registered=1', 900);
      });
    </script>
  </body>
</html>
